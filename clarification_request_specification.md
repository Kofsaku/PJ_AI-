# AIコールシステム - 明確化要求（clarification_request）機能 仕様書

## 📋 概要

### clarification_requestとは何か

「明確化要求（clarification_request）」は、AIコールシステムで電話をかけた際に、お客様から以下のような質問や聞き返しがあった場合に、AIが適切に対応する機能です：

- **「ご用件は何ですか？」** - 電話の目的を聞き返される
- **「どちらの会社様ですか？」** - 会社名を確認される
- **「はい？」「もしもし？」** - 聞こえない・聞き取れない
- **「もう一度説明してください」** - 再度説明を求められる

これらの様々な「聞き返し」や「確認」を一つの機能として統合し、適切な応答を自動で行います。

## 🔄 統合前後の変更点

### 統合前（問題があった状態）
- `purpose_inquiry`（用件確認）
- `company_inquiry`（会社確認）
- `clarification_request`（聞き返し）

これらが**別々の機能**として管理されていたため：
- 似たような内容でもAIが混乱する
- 応答が一貫しない
- システムが複雑になる

### 統合後（改善された状態）
**すべて`clarification_request`として統一**

お客様がどのような聞き返しをしても、同じ明確で丁寧な応答をします：
```
失礼しました。{{会社名}}の{{担当者名}}です。{{サービス名}}についてご担当者さまにご案内の可否を伺っております。
```

## 🔍 対応するキーワード一覧

システムが`clarification_request`として認識するキーワードは以下の通りです：

### 用件確認系
- ご用件
- 用件は
- 用件を
- どういった
- なんの用
- 何の件
- どのような
- どんな
- 何のお話
- 用事は
- どちらの件

### 会社確認系
- 社名
- どちら様
- 会社名
- お名前
- どこの
- どちらから
- もう一度社名を
- 社名をもう一度
- 会社名をもう一度

### 聞き返し系
- はい？
- もしもし？
- えっ？
- 聞こえない
- 聞き取れない
- 聞こえませんでした
- 聞こえません

### 再説明要求系
- なんでしょう
- 何でしょうか
- もう一度教えて
- もう一度説明
- 再度教えて
- もう一度お聞かせ願えますか
- もう一度お願いします
- 用件教えて
- 用件を教えて
- 教えてください
- 教えて

## 💬 実際の会話例

### 例1：用件確認の場合

**お客様：** 「ご用件は何でしょうか？」

**AI応答：** 「失礼しました。AIコールシステム株式会社の佐藤です。営業支援AIサービスについてご担当者さまにご案内の可否を伺っております。」

### 例2：会社名確認の場合

**お客様：** 「どちらの会社様ですか？」

**AI応答：** 「失礼しました。AIコールシステム株式会社の佐藤です。営業支援AIサービスについてご担当者さまにご案内の可否を伺っております。」

### 例3：聞き返しの場合

**お客様：** 「はい？聞こえませんでした。」

**AI応答：** 「失礼しました。AIコールシステム株式会社の佐藤です。営業支援AIサービスについてご担当者さまにご案内の可否を伺っております。」

### 例4：再説明要求の場合

**お客様：** 「もう一度教えてください。」

**AI応答：** 「失礼しました。AIコールシステム株式会社の佐藤です。営業支援AIサービスについてご担当者さまにご案内の可否を伺っております。」

## ⚙️ 技術的な詳細

### 管理ファイル

#### 1. `/root/work_claude/PJ_AI-/backend/config/templates.js`
**役割：** キーワード定義と応答テンプレートの管理

**重要な部分：**
```javascript
// 統合された明確化要求（用件確認、会社確認、聞き返し）
clarification_request: {
  keywords: [
    // 用件確認系
    'ご用件', '用件は', '用件を', 'どういった', 'なんの用', '何の件',
    'どのような', 'どんな', '何のお話', '用事は', 'どちらの件',

    // 会社確認系
    '社名', 'どちら様', '会社名', 'お名前', 'どこの', 'どちらから',
    'もう一度社名を', '社名をもう一度', '会社名をもう一度',

    // 聞き返し系
    'はい？', 'もしもし？', 'えっ？', '聞こえない', '聞き取れない',
    '聞こえませんでした', '聞こえません',

    // 再説明要求系
    'なんでしょう', '何でしょうか', 'もう一度教えて', 'もう一度説明',
    '再度教えて', 'もう一度お聞かせ願えますか', 'もう一度お願いします',
    '用件教えて', '用件を教えて', '教えてください', '教えて'
  ],
  confidence: 0.85,
  priority: 2
}
```

**応答テンプレート：**
```javascript
clarification: '失礼しました。{{companyName}}の{{representativeName}}です。{{serviceName}}についてご担当者さまにご案内の可否を伺っております。'
```

#### 2. `/root/work_claude/PJ_AI-/backend/services/conversationEngine.js`
**役割：** 音声認識結果の分類と応答生成

**重要な処理：**
- お客様の発言を分析
- キーワードマッチング
- 適切な応答の生成

#### 3. `/root/work_claude/PJ_AI-/backend/models/AgentSettings.js`
**役割：** カスタム応答テンプレートの管理

**カスタマイズ可能な部分：**
```javascript
clarification: {
  type: String,
  default: '失礼しました。{{companyName}}の{{representativeName}}です。{{serviceName}}についてご担当者さまにご案内の可否を伺っております。'
}
```

### テンプレート変数

応答メッセージでは以下の変数が自動で置き換えられます：

- `{{companyName}}` → 会社名（例：AIコールシステム株式会社）
- `{{representativeName}}` → 担当者名（例：佐藤）
- `{{serviceName}}` → サービス名（例：営業支援AIサービス）

## 🔧 設定のカスタマイズ方法

### 1. 基本設定の変更
管理画面から以下を設定できます：
- 会社名
- 担当者名
- サービス名

### 2. 応答メッセージのカスタマイズ
AgentSettingsで`clarification`テンプレートを編集することで、応答内容を変更できます。

### 3. キーワードの追加
必要に応じて`templates.js`の`clarification_request.keywords`配列に新しいキーワードを追加できます。

## 🚨 トラブルシューティング

### よくある問題と解決方法

#### 問題1：AIが明確化要求を正しく認識しない

**症状：** お客様が「ご用件は？」と聞いても、AIが別の応答をする

**原因：**
- 新しいキーワードパターンが登録されていない
- 音声認識の精度が低い

**解決方法：**
1. `templates.js`のキーワードリストを確認
2. 必要に応じて新しいキーワードを追加
3. 音声認識の設定を確認

#### 問題2：応答メッセージが正しく表示されない

**症状：** 「{{companyName}}の{{representativeName}}です」がそのまま読み上げられる

**原因：**
- AgentSettingsに会社名や担当者名が設定されていない
- テンプレート処理エラー

**解決方法：**
1. AgentSettingsの設定を確認
2. 必須フィールドに値が入っているか確認
3. システムログでエラーを確認

#### 問題3：同じ質問に対して毎回違う応答をする

**症状：** 一貫性のない応答

**原因：**
- 複数の機能が競合している
- 統合処理が正しく動作していない

**解決方法：**
1. `globalPatterns`の設定を確認
2. 統合処理が有効になっているか確認
3. ログで意図認識結果を確認

### ログの確認方法

システムログで以下の情報を確認できます：

```
[ConversationEngine] Global pattern matched: clarification_request with confidence 0.85
[ConversationEngine] 明確化要求
```

この表示があれば、機能が正しく動作しています。

## 📊 機能の優先度

`clarification_request`は**priority: 2**に設定されており、以下の順序で処理されます：

1. **Priority 1:** 即終了系（rejection, absent, website_redirect）
2. **Priority 2:** 明確化要求（clarification_request）
3. **Priority 3:** その他の応答

これにより、お客様からの聞き返しに対して迅速かつ正確に対応できます。

## 🎯 期待される効果

この機能により、以下の改善が期待されます：

1. **応答の一貫性向上** - どのような聞き返しでも同じ品質の応答
2. **顧客満足度向上** - 明確で分かりやすい説明
3. **システムの簡素化** - 複数機能の統合によるメンテナンス性向上
4. **応答精度向上** - より多くのキーワードパターンへの対応

---

このドキュメントは、開発者ではない方でもAIコールシステムの明確化要求機能を理解し、適切に運用できるように作成されています。不明な点があれば、技術サポートまでお問い合わせください。