# メール認証機能実装計画

## 概要

新規ユーザー登録時にメールアドレス認証を行うフローを実装する。企業情報入力後、メールアドレス入力→認証コード送信→認証コード入力→アカウント作成の流れを構築する。

## 現在の登録フロー

### 既存フロー
1. 企業ID入力・確認
2. ユーザー情報入力（メール、パスワード、個人情報等）
3. 即座にアカウント作成・JWTトークン発行

### 問題点
- メールアドレスの有効性確認なし
- セキュリティリスク（無効なメールでアカウント作成可能）
- スパムアカウント作成の可能性

## 新しい登録フロー設計

### 改善後フロー
1. **Step 1**: 企業ID入力・企業情報確認
2. **Step 2**: 企業詳細情報入力（既存）
3. **Step 3**: メールアドレス入力（新規）
4. **Step 4**: 認証コード送信・入力（新規）
5. **Step 5**: アカウント情報入力（名前、パスワード）
6. **Step 6**: アカウント作成完了

## 技術実装要件

### 1. データベース設計

#### 新しいコレクション: `EmailVerification`
```javascript
{
  email: String,           // 認証対象のメールアドレス
  verificationCode: String, // 6桁の認証コード
  companyId: String,       // 関連企業ID
  companyData: Object,     // Step2で入力された企業情報
  expiresAt: Date,         // 認証コード有効期限（10分）
  isVerified: Boolean,     // 認証完了フラグ
  createdAt: Date,
  attempts: Number         // 認証試行回数（セキュリティ対策）
}
```

#### Userモデルの変更
```javascript
// 新フィールド追加
isEmailVerified: {
  type: Boolean,
  default: false
},
emailVerifiedAt: Date
```

### 2. バックエンドAPI設計

#### 新規エンドポイント

1. **POST /api/auth/send-verification-code**
   - メールアドレスと企業情報を受信
   - 認証コード生成・メール送信
   - EmailVerificationレコード作成

2. **POST /api/auth/verify-email-code**
   - メールアドレスと認証コードを受信
   - 認証コード検証
   - 一時トークン発行（アカウント作成用）

3. **POST /api/auth/complete-registration**
   - 一時トークンと名前・パスワードを受信
   - Userアカウント作成
   - 本トークン発行

#### 既存エンドポイントの変更

- **POST /api/auth/signup**: 廃止または大幅変更
- 新しいフローに合わせた分割実装

### 3. メール送信機能

#### 依存関係追加
```json
{
  "nodemailer": "^6.9.0",
  "nodemailer-smtp-transport": "^2.7.4"
}
```

#### メール設定
- SMTP設定（Gmail, SendGrid, AWS SES等）
- テンプレート管理
- 送信ログ・エラーハンドリング

#### メールテンプレート
```
件名: [システム名] メールアドレス認証のお願い

○○様

この度は当システムにご登録いただき、ありがとうございます。
以下の認証コードを入力してメールアドレス認証を完了してください。

認証コード: 123456

※このコードは10分間有効です。
※このメールに心当たりがない場合は、このメールを無視してください。
```

### 4. セキュリティ対策

#### 認証コード生成
- 6桁数字（100000-999999）
- 暗号学的に安全な乱数生成
- 有効期限: 10分

#### レート制限
- 同一メールアドレスへの送信: 1分間に1回
- 同一IPからの送信: 1時間に10回
- 認証試行: 5回まで

#### データ保護
- 認証コードのハッシュ化保存
- 個人情報の一時保存期間制限
- 失敗時のログ記録

### 5. フロントエンド設計

#### 新規画面

1. **メールアドレス入力画面**
   - メールアドレス入力フォーム
   - 企業情報確認表示
   - 「認証コードを送信」ボタン

2. **認証コード入力画面**
   - 6桁数字入力フィールド
   - 再送信ボタン（60秒クールダウン）
   - 残り時間表示

3. **アカウント情報入力画面**
   - 名前（姓・名）
   - パスワード・パスワード確認
   - 利用規約同意チェック

#### UX改善

- ステップ進行表示
- 入力値の一時保存
- エラーメッセージの改善
- 認証コード自動フォーカス
- ペースト対応

### 6. 環境設定

#### 新しい環境変数
```bash
# メール設定
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
EMAIL_FROM=noreply@yourapp.com

# 認証設定
VERIFICATION_CODE_EXPIRY=600  # 10分（秒）
MAX_VERIFICATION_ATTEMPTS=5
VERIFICATION_RATE_LIMIT=60   # 1分（秒）
```

### 7. テスト計画

#### 単体テスト
- 認証コード生成・検証
- メール送信機能
- レート制限機能
- データベース操作

#### 結合テスト
- 登録フロー全体
- エラーケース
- セキュリティテスト

#### E2Eテスト
- ユーザー操作シナリオ
- メール送受信
- タイムアウト処理

### 8. 実装順序

#### Phase 1: バックエンド基盤
1. EmailVerificationモデル作成
2. メール送信サービス実装
3. 認証コード生成・検証機能

#### Phase 2: API実装
1. 認証コード送信API
2. 認証コード検証API
3. アカウント作成完了API

#### Phase 3: フロントエンド実装
1. メールアドレス入力画面
2. 認証コード入力画面
3. アカウント情報入力画面

#### Phase 4: 統合・テスト
1. フロー統合
2. エラーハンドリング
3. セキュリティテスト
4. UI/UXテスト

### 9. 運用考慮事項

#### 監視・ログ
- メール送信成功/失敗率
- 認証成功/失敗率
- 不正アクセス試行

#### パフォーマンス
- メール送信キュー
- データベースインデックス
- 期限切れデータの自動削除

#### 障害対応
- メール送信障害時の代替手段
- データベース障害時の復旧手順
- ロールバック手順

## 完了条件

- [ ] 新規登録フローが正常に動作する
- [ ] メール認証が適切に機能する
- [ ] セキュリティ要件が満たされる
- [ ] 既存機能に影響を与えない
- [ ] パフォーマンス要件が満たされる
- [ ] テストが全て通る

## リスク・注意事項

1. **既存ユーザーへの影響**: 既存のユーザーは `isEmailVerified: false` となる可能性
2. **メール送信コスト**: 送信量の増加に伴うコスト
3. **スパム判定**: 認証メールがスパムフォルダに入る可能性
4. **実装複雑化**: コード複雑度の増加
5. **UX悪化**: 登録手順の増加による離脱率上昇の可能性