# 顧客データ分離問題 - 修正メモ

## 発見日時
2025年1月10日

## 問題の概要
新規企業（企業ID: hcW_ksQLBx9mpz6jHBZp1g）を作成したにも関わらず、他企業の顧客データが表示される重大なデータ分離問題が発生。

## 根本原因

### 1. データモデルの設計不備
- **Customerモデルに企業ID（companyId）フィールドが存在しない**
  - ファイル: `/backend/models/Customer.js`
  - 顧客データがどの企業に属するか識別できない

### 2. APIの認証・フィルタリング不備
- **バックエンドAPI（/api/customers）が全顧客データを返却**
  - ファイル: `/backend/routes/customers.js` (L27)
  - `Customer.find()` で全データ取得、企業フィルタなし
  - 認証ミドルウェアが未実装

### 3. フロントエンドの認証情報送信不備
- **APIリクエスト時に認証トークンを送信していない**
  - ファイル: `/frontend/app/api/customers/route.ts`
  - ユーザー情報・企業情報が送信されていない

## 修正必要項目

### Phase 1: データモデル修正
1. **Customerスキーマに企業IDフィールド追加**
   ```javascript
   companyId: {
     type: String,
     required: true,
     index: true
   }
   ```

### Phase 2: バックエンド修正
1. **認証ミドルウェアの追加**
   - `/backend/middlewares/auth.js` の利用
   - customers ルートに認証を適用

2. **顧客取得APIの修正**
   ```javascript
   // 修正前
   const customers = await Customer.find();
   
   // 修正後
   const customers = await Customer.find({ 
     companyId: req.user.companyId 
   });
   ```

3. **顧客作成時に企業ID自動設定**
   ```javascript
   const customer = new Customer({
     ...req.body,
     companyId: req.user.companyId
   });
   ```

### Phase 3: フロントエンド修正
1. **API呼び出し時の認証トークン送信**
   ```typescript
   const token = localStorage.getItem('token');
   const response = await fetch(API_BASE_URL, {
     headers: {
       'Authorization': `Bearer ${token}`,
       'Content-Type': 'application/json',
     }
   });
   ```

2. **全てのcustomer関連APIエンドポイントの更新**
   - GET /api/customers
   - POST /api/customers
   - PATCH /api/customers/:id
   - DELETE /api/customers

### Phase 4: データマイグレーション
1. **既存顧客データの処理**
   - 既存データに企業IDを追加
   - またはテストデータのため全削除

### Phase 5: テスト項目
1. **マルチテナント分離の確認**
   - 企業A のユーザーが企業B の顧客データにアクセスできないこと
   - 新規企業作成時に顧客リストが空であること

2. **CRUD操作の確認**
   - 顧客作成時に自動的に企業IDが設定されること
   - 顧客一覧取得時に自企業のデータのみ表示されること
   - 顧客更新・削除が自企業のデータのみ可能であること

## 影響範囲
- 顧客管理機能全般
- 通話履歴機能（CallSessionモデルも要確認）
- CSVインポート機能
- 一括通話機能

## 優先度
**最高** - セキュリティとデータプライバシーに関わる重大な問題

## 推定作業時間
2-3時間（テスト含む）

## 備考
- 開発環境のため既存データは全てテストデータ
- システム崩壊のリスクは低い
- 同様の問題が他のモデル（CallSession等）にも存在する可能性あり